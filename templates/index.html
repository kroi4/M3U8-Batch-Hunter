<!doctype html>
<html lang="he" dir="rtl">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Batch HLS Downloader UI</title>
    <style>
      :root{--b:#e5e7eb;--bg:#f9fafb;--muted:#6b7280;}
      body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:2rem;background:var(--bg);}
      .card{max-width:1000px;margin:auto;border:1px solid var(--b);border-radius:16px;padding:1.25rem;background:#fff;box-shadow:0 1px 6px rgba(0,0,0,.06);}
      .row{display:flex;gap:1rem;align-items:center;flex-wrap:wrap;}
      label{font-weight:600;}
      input[type="text"]{padding:.6rem;border:1px solid var(--b);border-radius:.6rem;width:100%;}
      .muted{color:var(--muted);font-size:.95rem}
      button{padding:.6rem 1rem;border:0;border-radius:.7rem;background:#111;color:#fff;cursor:pointer}
      button:hover{opacity:.9}
      table{width:100%;border-collapse:collapse;margin-top:1rem}
      th,td{border-bottom:1px solid var(--b);padding:.6rem;text-align:right}
      tr:hover{background:#fafafa}
      .icon-btn{background:#f3f4f6;border:1px solid var(--b);color:#111}
      details{background:#f7f7f7;border:1px solid var(--b);border-radius:.6rem;padding:.6rem;margin-top:.4rem}
      .status{font-size:1.2rem}
      .flex{display:flex;gap:.5rem;align-items:center}
      .chip{display:inline-block;padding:.15rem .45rem;border:1px solid var(--b);border-radius:.6rem;font-size:.8rem;color:#374151}
      .footer{margin-top:1rem;display:flex;gap:.6rem;justify-content:space-between;align-items:center;flex-wrap:wrap}
    </style>
  </head>
  <body>
    <div class="card">
      <h1>×××©×§ ×”×•×¨×“×” ××¨×•×‘×ª ×§×™×©×•×¨×™× (×—×›×)</h1>
      <p class="muted">×× ×¡×” ×ª×—×™×œ×” yt-dlp (××”×™×¨, ×›×œ×œ×™), ×•×× × ×›×©×œ ×¢×•×‘×¨ ××•×˜×•××˜×™×ª ×œ-Selenium (Kaltura/13tv). ×ª×•××š ×‘×”×•×¨×“×” ××§×‘×™×œ×™×ª ×¢× ×¤×¡ ×”×ª×§×“××•×ª!</p>
      <div class="row" style="margin:.5rem 0 1rem">
        <div style="flex:1;min-width:280px">
          <label for="outDir">×ª×™×§×™×™×ª ×™×¢×“</label>
          <div style="display:flex;gap:.5rem">
            <input id="outDir" type="text" placeholder="×œ×“×•×’××”: D:\\Videos ××• /home/user/Videos" style="flex:1">
            <button type="button" class="icon-btn" onclick="browseFolder()" title="×¢×™×•×Ÿ ×‘×ª×™×§×™×•×ª">ğŸ“</button>
          </div>
          <div class="muted">×”×“×‘×§/×”×§×œ×“ × ×ª×™×‘ ×ª×™×§×™×™×” ××§×•××™×ª. ×× ×¨×™×§, ×™×™×©××¨ ×‘×ª×™×§×™×™×” ×©×œ ×”×¤×¨×•×™×§×˜.</div>
        </div>
        <div class="flex" style="gap:.5rem">
          <label>××§×‘×™×œ×™×•×ª</label>
          <input id="concurrency" type="number" min="1" max="6" value="2" style="width:64px;padding:.3rem;border:1px solid var(--b);border-radius:.4rem">
        </div>
      </div>

      <table id="urlsTable">
        <thead>
          <tr>
            <th style="width:48px"></th>
            <th>×›×ª×•×‘×ª ××ª×¨</th>
            <th>×›×•×ª×¨×ª</th>
            <th style="width:80px">×¡×˜×˜×•×¡</th>
          </tr>
        </thead>
        <tbody id="rows">
        </tbody>
      </table>

      <div class="footer">
        <div class="flex">
          <button class="icon-btn" onclick="addRow()">+ ×”×•×¡×£ ×›×ª×•×‘×ª</button>
          <span class="muted">×˜×™×¤: ××¤×©×¨ ×œ×”×“×‘×™×§ ×›××” URLs ×‘×©×•×¨×•×ª ×©×•× ×•×ª.</span>
        </div>
        <button onclick="runBatch()">×”×¨×¦×”</button>
      </div>

      <template id="rowTpl">
        <tr>
          <td><button class="icon-btn" onclick="toggleDetails(this)">â–¸</button></td>
          <td><input type="text" class="url" style="width:100%" placeholder="https://..."></td>
          <td class="title muted">â€”</td>
          <td class="status">âŒ›</td>
        </tr>
        <tr class="details-row" style="display:none">
          <td colspan="4">
            <!-- Progress Bar - Always Visible -->
            <div class="progress-container" style="background:#f7f7f7;border:1px solid var(--b);border-radius:.6rem;padding:.8rem;margin-bottom:.5rem">
              <div class="progress-status muted" style="font-size:.9rem;margin-bottom:.5rem">×××ª×™×Ÿ ×œ×”×ª×—×œ×”...</div>
              <div style="height:12px;background:#e5e7eb;border-radius:8px;overflow:hidden">
                <div class="bar" style="height:12px;width:0%;background:#16a34a;transition:width 0.3s ease"></div>
              </div>
              <div class="muted" style="font-size:.85rem;margin-top:.3rem"><span class="pct">0%</span> <span class="eta"></span></div>
            </div>
            
            <!-- Details Section -->
            <details style="background:#f7f7f7;border:1px solid var(--b);border-radius:.6rem;padding:.6rem;margin-bottom:.5rem">
              <summary style="cursor:pointer;font-weight:600">ğŸ“‹ ×¤×¨×˜×™×</summary>
              <div class="details-text muted" style="margin-top:.5rem;white-space:pre-wrap;line-height:1.6">â€”</div>
            </details>
            
            <!-- Debug Section -->
            <details style="background:#f7f7f7;border:1px solid var(--b);border-radius:.6rem;padding:.6rem">
              <summary style="cursor:pointer;font-weight:600">ğŸ”§ Debug (FFmpeg)</summary>
              <div class="debug-text muted" style="margin-top:.5rem;font-family:monospace;font-size:.75rem;word-break:break-all;line-height:1.4">â€”</div>
            </details>
          </td>
        </tr>
      </template>
    </div>

    <script>
      // Load saved directory on page load
      window.addEventListener('DOMContentLoaded', ()=>{
        const saved = localStorage.getItem('lastOutputDir');
        if(saved){
          document.getElementById('outDir').value = saved;
        }
      });

      function addRow(val="") {
        const tpl = document.getElementById('rowTpl').content.cloneNode(true);
        const urlInput = tpl.querySelector('input.url');
        urlInput.value = val;
        document.getElementById('rows').appendChild(tpl);
      }
      function toggleDetails(btn){
        const tr = btn.closest('tr');
        const next = tr.nextElementSibling;
        if(!next || !next.classList.contains('details-row')) return;
        const open = next.style.display !== 'none';
        next.style.display = open ? 'none' : '';
        btn.textContent = open ? 'â–¸' : 'â–¾';
      }

      async function browseFolder(){
        try {
          // Use File System Access API for directory picker
          const dirHandle = await window.showDirectoryPicker();
          // Get the full path (note: this is limited in browsers for security)
          // We'll use the directory name as a fallback
          const path = dirHandle.name;
          
          // Unfortunately, browsers don't expose full paths for security reasons
          // So we'll prompt the user to paste the full path
          const fullPath = prompt('×”×“×¤×“×¤×Ÿ ×œ× ×™×›×•×œ ×œ×§×¨×•× ××ª ×”× ×ª×™×‘ ×”××œ× ××¡×™×‘×•×ª ××‘×˜×—×”.\n×”×“×‘×§ ××ª ×”× ×ª×™×‘ ×”××œ× ×©×œ ×”×ª×™×§×™×™×” ×©×‘×—×¨×ª:', '');
          if(fullPath){
            document.getElementById('outDir').value = fullPath.trim();
            localStorage.setItem('lastOutputDir', fullPath.trim());
          }
        } catch(e) {
          // Fallback: just let user type
          alert('×”×“×¤×“×¤×Ÿ ×œ× ×ª×•××š ×‘×‘×—×™×¨×ª ×ª×™×§×™×•×ª.\n×”×§×œ×“ ××ª ×”× ×ª×™×‘ ×™×“× ×™×ª ×‘×©×“×”.');
        }
      }

      // start with one row
      addRow();

      async function runBatch(){
        const outDir = document.getElementById('outDir').value.trim();
        const concurrency = Math.max(1, Math.min(6, parseInt(document.getElementById('concurrency').value || '2')));
        const rows = Array.from(document.querySelectorAll('#rows tr')).filter((_,i)=>i%2===0);
        const urls = rows.map(r=>r.querySelector('input.url').value.trim()).filter(Boolean);
        if(urls.length===0){ alert('×”×•×¡×£ ×œ×¤×—×•×ª ×›×ª×•×‘×ª ××—×ª.'); return; }
        
        // Save the output directory for next time
        if(outDir){
          localStorage.setItem('lastOutputDir', outDir);
        }

        // reset UI
        rows.forEach(r=>{
          r.querySelector('.title').textContent = '×××ª×™×Ÿ...';
          r.querySelector('.title').classList.add('muted');
          r.querySelector('.status').textContent = 'âŒ›';
          const detailsRow = r.nextElementSibling;
          detailsRow.querySelector('.progress-status').textContent = '×××ª×™×Ÿ ×œ×”×ª×—×œ×”...';
          detailsRow.querySelector('.details-text').textContent = 'â€”';
          detailsRow.querySelector('.debug-text').textContent = 'â€”';
          detailsRow.querySelector('.pct').textContent = '0%';
          detailsRow.querySelector('.bar').style.width = '0%';
          detailsRow.querySelector('.bar').style.background = '#16a34a';
          detailsRow.querySelector('.eta').textContent = '';
        });

        // Use fetch with streaming response
        const response = await fetch('/run-batch', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ out_dir: outDir, urls, concurrency })
        });

        if(!response.ok){
          alert('×©×’×™××” ×‘×©×¨×ª');
          return;
        }

        // Read SSE stream
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';

        while(true){
          const {done, value} = await reader.read();
          if(done) break;
          
          buffer += decoder.decode(value, {stream: true});
          const lines = buffer.split('\n');
          buffer = lines.pop(); // Keep incomplete line in buffer
          
          for(const line of lines){
            if(line.startsWith('data: ')){
              try{
                const data = JSON.parse(line.slice(6));
                const idx = data.index;
                
                if(data.type === 'title'){
                  // Update title immediately
                  rows[idx].querySelector('.title').textContent = data.title;
                  rows[idx].querySelector('.title').classList.remove('muted');
                  rows[idx].querySelector('.status').textContent = 'ğŸ”„';
                  const statusEl = rows[idx].nextElementSibling.querySelector('.progress-status');
                  statusEl.textContent = 'ğŸ”„ ××ª×—×™×œ ×œ×”×•×¨×™×“...';
                }
                else if(data.type === 'progress'){
                  // Update progress in real-time
                  rows[idx].querySelector('.status').textContent = 'â¬‡ï¸';
                  const detailsRow = rows[idx].nextElementSibling;
                  const statusEl = detailsRow.querySelector('.progress-status');
                  const pctEl = detailsRow.querySelector('.pct');
                  const barEl = detailsRow.querySelector('.bar');
                  const etaEl = detailsRow.querySelector('.eta');
                  
                  // Update progress bar and percentage
                  if(typeof data.percent === 'number'){
                    pctEl.textContent = data.percent.toFixed(1) + '%';
                    barEl.style.width = data.percent.toFixed(1) + '%';
                  }
                  
                  // Update ETA
                  if(typeof data.eta === 'number'){
                    etaEl.textContent = 'â±ï¸ ETA ' + Math.max(0, data.eta|0) + 's';
                  }
                  
                  // Update status message (FFmpeg progress or general status)
                  if(data.status === 'fallback'){
                    statusEl.textContent = 'ğŸ”„ ' + (data.filename || '×× ×¡×” ×©×™×˜×ª fallback...');
                  }
                  else if(data.status === 'selenium'){
                    statusEl.textContent = 'ğŸ”„ ' + (data.filename || '××¢×‘×“ ×¢× Selenium...');
                  }
                  else if(data.filename){
                    statusEl.textContent = 'â¬‡ï¸ ' + data.filename;
                  }
                }
                else if(data.type === 'result'){
                  // Update with final result
                  rows[idx].querySelector('.title').textContent = data.title || 'â€”';
                  rows[idx].querySelector('.status').textContent = data.emoji || 'âŒ';
                  
                  const detailsRow = rows[idx].nextElementSibling;
                  const statusEl = detailsRow.querySelector('.progress-status');
                  const det = detailsRow.querySelector('.details-text');
                  const debugEl = detailsRow.querySelector('.debug-text');
                  const pctEl = detailsRow.querySelector('.pct');
                  const barEl = detailsRow.querySelector('.bar');
                  
                  // Update details section with clean, formatted info
                  det.textContent = data.details || 'â€”';
                  
                  // Update debug section with FFmpeg command and technical info
                  let debugInfo = '';
                  if(data.ffmpeg_cmd){
                    debugInfo += '×¤×§×•×“×ª FFmpeg:\n' + data.ffmpeg_cmd + '\n\n';
                  }
                  if(data.output){
                    debugInfo += '×§×•×‘×¥ ×™×¢×“:\n' + data.output;
                  }
                  debugEl.textContent = debugInfo || '××™×Ÿ ××™×“×¢ debug ×–××™×Ÿ';
                  
                  // Update progress status
                  if(data.status === 'ok'){
                    statusEl.textContent = 'âœ… ×”×•×©×œ× ×‘×”×¦×œ×—×”!';
                    pctEl.textContent = '100%';
                    barEl.style.width = '100%';
                    barEl.style.background = '#16a34a'; // Green
                  } else {
                    statusEl.textContent = 'âŒ × ×›×©×œ';
                    barEl.style.background = '#dc2626'; // Red
                  }
                }
                else if(data.type === 'done'){
                  console.log('×”×•×©×œ×!');
                }
              }catch(e){
                console.error('Parse error:', e);
              }
            }
          }
        }
      }
    </script>
  </body>
</html>
